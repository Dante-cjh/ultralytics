#!/bin/bash
# -*- coding: utf-8 -*-

################################################################################
# å¤šå°ºåº¦æ¨ç†æµ‹è¯•è„šæœ¬
# ç”¨äºå¿«é€Ÿæµ‹è¯•å’Œå¯¹æ¯”ä¸åŒæ¨ç†æ–¹æ³•çš„æ€§èƒ½
################################################################################

set -e

echo "========================================"
echo "å¤šå°ºåº¦æ¨ç†æµ‹è¯•è„šæœ¬"
echo "========================================"

# ============================================================================
# é…ç½®å‚æ•°ï¼ˆè¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ï¼‰
# ============================================================================

# æ¨¡å‹è·¯å¾„
MODEL="runs/detect/D1_yolo11m_1280_20241201_120000/weights/best.pt"

# æµ‹è¯•æ•°æ®è·¯å¾„
TEST_DIR="/public/home/baichen/download/dcu_yolo/ultralytics/data/D1_type3/yolo_format/images/test"

# è®¾å¤‡
DEVICE="cuda:0"

# æ¨ç†å‚æ•°
CONFIDENCE=0.25
IOU_THRESHOLD=0.5

# ============================================================================
# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
# ============================================================================

if [ ! -f "${MODEL}" ]; then
    echo "âŒ é”™è¯¯: æ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨: ${MODEL}"
    echo "è¯·ä¿®æ”¹è„šæœ¬ä¸­çš„ MODEL å˜é‡ä¸ºæ­£ç¡®çš„æ¨¡å‹è·¯å¾„"
    exit 1
fi

if [ ! -d "${TEST_DIR}" ]; then
    echo "âŒ é”™è¯¯: æµ‹è¯•ç›®å½•ä¸å­˜åœ¨: ${TEST_DIR}"
    echo "è¯·ä¿®æ”¹è„šæœ¬ä¸­çš„ TEST_DIR å˜é‡ä¸ºæ­£ç¡®çš„æµ‹è¯•æ•°æ®è·¯å¾„"
    exit 1
fi

echo "âœ… æ¨¡å‹è·¯å¾„: ${MODEL}"
echo "âœ… æµ‹è¯•ç›®å½•: ${TEST_DIR}"
echo ""

# ============================================================================
# æµ‹è¯•1: æ ‡å‡†å•å°ºåº¦æ¨ç†ï¼ˆåŸºå‡†ï¼‰
# ============================================================================

echo "========================================"
echo "æµ‹è¯•1: æ ‡å‡†å•å°ºåº¦æ¨ç† (imgsz=1280)"
echo "========================================"

python3 balloon_inference.py \
    --model "${MODEL}" \
    --source "${TEST_DIR}" \
    --imgsz 1280 \
    --confidence ${CONFIDENCE} \
    --iou ${IOU_THRESHOLD} \
    --device "${DEVICE}" \
    --save-dir "runs/inference/test1_standard_1280"

echo ""
echo "âœ… æµ‹è¯•1å®Œæˆ"
echo ""

# ============================================================================
# æµ‹è¯•2: å¤šå°ºåº¦æ¨ç† + NMS (å¿«é€Ÿ)
# ============================================================================

echo "========================================"
echo "æµ‹è¯•2: å¤šå°ºåº¦æ¨ç† + NMS (2ä¸ªå°ºåº¦)"
echo "========================================"

python3 balloon_inference_multiscale.py \
    --model "${MODEL}" \
    --source "${TEST_DIR}" \
    --scales 832 1280 \
    --fusion nms \
    --confidence ${CONFIDENCE} \
    --iou ${IOU_THRESHOLD} \
    --device "${DEVICE}" \
    --save-dir "runs/inference/test2_multiscale_2scales_nms"

echo ""
echo "âœ… æµ‹è¯•2å®Œæˆ"
echo ""

# ============================================================================
# æµ‹è¯•3: å¤šå°ºåº¦æ¨ç† + NMS (æ ‡å‡†)
# ============================================================================

echo "========================================"
echo "æµ‹è¯•3: å¤šå°ºåº¦æ¨ç† + NMS (3ä¸ªå°ºåº¦)"
echo "========================================"

python3 balloon_inference_multiscale.py \
    --model "${MODEL}" \
    --source "${TEST_DIR}" \
    --scales 832 1024 1280 \
    --fusion nms \
    --confidence ${CONFIDENCE} \
    --iou ${IOU_THRESHOLD} \
    --device "${DEVICE}" \
    --save-dir "runs/inference/test3_multiscale_3scales_nms"

echo ""
echo "âœ… æµ‹è¯•3å®Œæˆ"
echo ""

# ============================================================================
# æµ‹è¯•4: å¤šå°ºåº¦æ¨ç† + WBF (æœ€ä½³ç²¾åº¦)
# ============================================================================

echo "========================================"
echo "æµ‹è¯•4: å¤šå°ºåº¦æ¨ç† + WBF (3ä¸ªå°ºåº¦)"
echo "========================================"

# æ£€æŸ¥æ˜¯å¦å®‰è£…äº† ensemble-boxes
if python3 -c "import ensemble_boxes" 2>/dev/null; then
    python3 balloon_inference_multiscale.py \
        --model "${MODEL}" \
        --source "${TEST_DIR}" \
        --scales 832 1024 1280 \
        --fusion wbf \
        --confidence ${CONFIDENCE} \
        --iou 0.45 \
        --device "${DEVICE}" \
        --save-dir "runs/inference/test4_multiscale_3scales_wbf"
    
    echo ""
    echo "âœ… æµ‹è¯•4å®Œæˆ"
else
    echo "âš ï¸  è·³è¿‡æµ‹è¯•4: ensemble-boxes æœªå®‰è£…"
    echo "   å®‰è£…å‘½ä»¤: pip install ensemble-boxes"
fi

echo ""

# ============================================================================
# æµ‹è¯•5: å¤šå°ºåº¦æ¨ç† + NMS (æé™ç²¾åº¦)
# ============================================================================

echo "========================================"
echo "æµ‹è¯•5: å¤šå°ºåº¦æ¨ç† + NMS (4ä¸ªå°ºåº¦)"
echo "========================================"

python3 balloon_inference_multiscale.py \
    --model "${MODEL}" \
    --source "${TEST_DIR}" \
    --scales 640 832 1024 1280 \
    --fusion nms \
    --confidence ${CONFIDENCE} \
    --iou ${IOU_THRESHOLD} \
    --device "${DEVICE}" \
    --save-dir "runs/inference/test5_multiscale_4scales_nms"

echo ""
echo "âœ… æµ‹è¯•5å®Œæˆ"
echo ""

# ============================================================================
# æ€»ç»“
# ============================================================================

echo "========================================"
echo "ğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼"
echo "========================================"
echo ""
echo "ğŸ“Š ç»“æœä½ç½®:"
echo "   æµ‹è¯•1 (æ ‡å‡†): runs/inference/test1_standard_1280/"
echo "   æµ‹è¯•2 (å¤šå°ºåº¦2): runs/inference/test2_multiscale_2scales_nms/"
echo "   æµ‹è¯•3 (å¤šå°ºåº¦3): runs/inference/test3_multiscale_3scales_nms/"
echo "   æµ‹è¯•4 (WBF): runs/inference/test4_multiscale_3scales_wbf/"
echo "   æµ‹è¯•5 (å¤šå°ºåº¦4): runs/inference/test5_multiscale_4scales_nms/"
echo ""
echo "ğŸ’¡ å»ºè®®:"
echo "   1. æŸ¥çœ‹å„ä¸ªæµ‹è¯•çš„æ£€æµ‹ç»“æœå’Œå¯è§†åŒ–å›¾åƒ"
echo "   2. å¯¹æ¯”æ£€æµ‹åˆ°çš„ç›®æ ‡æ•°é‡"
echo "   3. è§‚å¯Ÿå°ç›®æ ‡çš„æ£€æµ‹æ•ˆæœ"
echo "   4. è®°å½•æ¨ç†æ—¶é—´ï¼Œé€‰æ‹©æœ€é€‚åˆçš„æ–¹æ³•"
echo ""
echo "ğŸ“ˆ é¢„æœŸç»“æœ:"
echo "   - å¤šå°ºåº¦æ¨ç†é€šå¸¸èƒ½æ£€æµ‹åˆ°æ›´å¤šç›®æ ‡"
echo "   - WBFçš„æ¡†ä½ç½®é€šå¸¸æ›´å‡†ç¡®"
echo "   - æ›´å¤šå°ºåº¦æ„å‘³ç€æ›´é«˜ç²¾åº¦ï¼Œä½†ä¹Ÿæ›´æ…¢"
echo ""
echo "========================================"

