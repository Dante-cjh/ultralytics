# 样本平衡策略详解

## 核心思想

你的理解是完全正确的！样本平衡的关键在于：

- **负样本过多** ❌ → 模型倾向预测背景，召回率低
- **负样本适中** ✅ → 平衡的学习
- **负样本过少** ⚠️ → 模型过于自信，泛化能力差

## 三种情况处理

### 情况1: 负样本过多（最常见）

**判断条件：**
```
负样本数 > 正样本数 × negative_ratio
```

**处理方式：**
```python
下采样负样本 → 正样本数 × negative_ratio
```

**示例：**
```
正样本: 263
负样本: 4620 (过多)
目标比例: 2:1

处理: 下采样负样本 4620 → 526
结果: 263正 + 526负 = 1:2.00 ✅
```

**优点：**
- ✅ 平衡类别分布
- ✅ 加速训练（样本减少83%)
- ✅ 提高对正样本的学习

---

### 情况2: 负样本适中

**判断条件：**
```
正样本数 × negative_ratio × 0.5 ≤ 负样本数 ≤ 正样本数 × negative_ratio
```

**处理方式：**
```python
保持不变
```

**示例：**
```
正样本: 100
负样本: 150
目标比例: 2:1 (即200)

判断: 100 ≤ 150 ≤ 200 ✅
处理: 无需调整，比例已经合理 (1:1.5)
```

---

### 情况3: 负样本过少 ⚠️

**判断条件：**
```
负样本数 < 正样本数 × negative_ratio × 0.5
```

**处理方式：**
```python
⚠️ 发出警告 + 给出建议
保持数据不变（不做处理）
```

**示例：**
```
正样本: 100
负样本: 50 (过少)
目标比例: 2:1 (即200)

判断: 50 < 100 (阈值) ⚠️
警告: 负样本过少，可能导致模型过于自信
建议: 
  1. 降低 --conf (如 0.05 → 0.01)
  2. 降低 --iou (如 0.5 → 0.3)
  3. 重新生成数据
```

## 为什么不自动补充负样本？

你的担心是对的：**负样本过少 >> 负样本过多**

但我们**不自动补充负样本**，原因：

1. **从哪里补充？**
   - 随机裁剪背景区域？可能裁到部分目标
   - 使用其他图像？可能引入不相关的样本
   - 风险较大，需要仔细设计

2. **更好的方案是调整数据生成参数**
   ```bash
   # 降低置信度，生成更多候选框
   --conf 0.05 → 0.01
   
   # 降低IOU阈值，更多框被标为负样本
   --iou 0.5 → 0.3
   ```

3. **让用户控制**
   - 用户可以根据警告调整参数
   - 重新生成数据（使用 --force）
   - 更可控，更透明

## 实际案例分析

### 案例1: Balloon训练集（典型的负样本过多）

```
原始数据:
  正样本: 263
  负样本: 4620
  比例: 1:17.57 ❌ 严重不平衡

参数配置:
  negative_ratio: 2.0
  target_negative: 263 × 2 = 526

处理结果:
  → 下采样负样本: 4620 → 526
  → 最终比例: 1:2.00 ✅

训练效率:
  样本数: 4883 → 789 (减少83.8%)
  训练时间: 15分钟/epoch → 2-3分钟/epoch ⚡
```

### 案例2: 假设负样本适中

```
假设数据:
  正样本: 100
  负样本: 180
  比例: 1:1.8

参数配置:
  negative_ratio: 2.0
  target_negative: 100 × 2 = 200
  阈值: 200 × 0.5 = 100

判断:
  100 ≤ 180 ≤ 200 ✅

处理:
  → 保持不变
  → 当前比例已经合理 (1:1.8 接近目标 1:2.0)
```

### 案例3: 假设负样本过少 ⚠️

```
假设数据:
  正样本: 100
  负样本: 80
  比例: 1:0.8

参数配置:
  negative_ratio: 2.0
  target_negative: 100 × 2 = 200
  阈值: 200 × 0.5 = 100

判断:
  80 < 100 ⚠️ 负样本过少!

处理:
  → 发出警告
  → 保持数据不变
  → 建议降低 --conf 或 --iou 重新生成

风险:
  模型可能过于自信，把很多背景也预测为目标
  
解决方案:
  # 降低置信度，重新生成数据
  python balloon_cascaded_detection.py prepare \
      --conf 0.01 \    # 从0.05降到0.01
      --iou 0.3 \       # 从0.5降到0.3
      --force           # 强制重新生成
```

## 参数调优策略

### 第一阶段置信度 (--conf)

| 场景 | 推荐值 | 说明 |
|------|--------|------|
| 中大目标 (Balloon) | 0.05 | 标准值 |
| 小目标 (D1) | 0.01 | 更低，获取更多候选框 |
| 负样本过少 | 0.01-0.005 | 极低，大幅增加候选框 |

**影响：**
- conf ↓ → 候选框 ↑ → 负样本 ↑

### IOU阈值 (--iou)

| 场景 | 推荐值 | 说明 |
|------|--------|------|
| 定位准确 (Balloon) | 0.5 | 标准值 |
| 小目标 (D1) | 0.3 | 更低，更宽松的匹配 |
| 负样本过少 | 0.2-0.3 | 更低，更多框被标为负样本 |

**影响：**
- iou ↓ → 正样本 ↑, 负样本 ↓
- iou ↑ → 正样本 ↓, 负样本 ↑

### 负样本比例 (--negative-ratio)

| 场景 | 推荐值 | 说明 |
|------|--------|------|
| 平衡（默认） | 2.0 | 负:正 = 2:1 |
| 提高召回率 | 1.5 | 负样本少一些 |
| 提高精确率 | 3.0 | 负样本多一些 |

**建议：**
- 从2.0开始实验
- 根据验证集表现调整

## 完整工作流程

### 1. 首次数据准备

```bash
# 使用默认参数
bash run_cascaded_detection.sh prepare
```

### 2. 检查输出

**情况A: 负样本过多（正常）**
```
⚖️  正负样本平衡...
   原始 - 正样本: 263, 负样本: 4620
   📉 负样本过多，进行下采样: 4620 → 526
   ✅ 平衡后 - 正样本: 263, 负样本: 526

→ 继续训练，无需调整
```

**情况B: 负样本适中（理想）**
```
⚖️  正负样本平衡...
   原始 - 正样本: 100, 负样本: 180
   ✅ 负样本数量在合理范围内，无需调整
   当前负样本比例: 1.80:1

→ 继续训练，无需调整
```

**情况C: 负样本过少（需要调整）⚠️**
```
⚖️  正负样本平衡...
   原始 - 正样本: 100, 负样本: 50
   ⚠️  警告: 负样本过少!
   当前负样本比例: 0.50:1 (目标: 2.00:1)
   
   💡 建议:
      1. 降低第一阶段置信度 (--conf)
      2. 降低IOU阈值 (--iou)
      3. 重新生成数据

→ 需要调整参数，重新生成数据！
```

### 3. 如果负样本过少，调整参数

**编辑 `run_cascaded_detection.sh`：**
```bash
# 降低置信度
STAGE1_CONF=0.01    # 从0.05降到0.01

# 降低IOU阈值（可选）
STAGE1_IOU=0.3      # 从0.5降到0.3
```

**重新生成数据：**
```bash
# 强制重新生成
FORCE_PREPARE=true bash run_cascaded_detection.sh prepare
```

### 4. 验证数据质量

```bash
# 查看统计信息
cat data/<model_name>_cascaded_data_balloon/train/stats.json

# 检查负样本比例是否合理
```

## 监控指标

### 训练过程中

观察分类器的表现：

```
Epoch 1:
  Train Acc: 85%  # 训练准确率
  Val Acc: 75%    # 验证准确率

问题诊断:
- Train Acc高 + Val Acc低 → 过拟合（可能负样本太少）
- 两者都低 → 模型容量不足或数据质量问题
- 两者都高 → 正常✅
```

### 最终评估

关注两阶段检测的表现：

```
单阶段YOLO: 31.93% (过度检测)
两阶段级联: 79.79% ✅

如果:
- 召回率低 → 可能负样本太多，分类器过于保守
- 精确率低 → 可能负样本太少，分类器过于激进
```

## 总结

### 设计原则

1. **负样本过多** → 自动下采样（安全）✅
2. **负样本适中** → 保持不变（理想）✅  
3. **负样本过少** → 警告提示（安全）⚠️

### 为什么这样设计？

- ✅ **安全**: 不自动添加可能有问题的样本
- ✅ **透明**: 用户清楚知道发生了什么
- ✅ **可控**: 用户可以通过调整参数解决问题
- ✅ **高效**: 自动处理最常见的情况（负样本过多）

### 你的理解

> "负样本过多可以提高conf，负样本过少更危险（模型过于自信）"

**完全正确！** ✅

我们的策略：
- 负样本过多 → 自动下采样（解决）
- 负样本过少 → 警告 + 建议降低conf（让用户解决）

这是最安全和可控的方案！

